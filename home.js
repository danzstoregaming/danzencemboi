/* ===== DATA ===== */
const DATA = [
  {
   "section": "grid-limited",
   "limited": true,
   "title": "Soul Vessel 2.0",
   "subtitle": "7 - 10 Hari",
   "via": "Gift",
   "img": "https://i.postimg.cc/ydYf8R20/Picsart_26_01_01_12_57_22_942.jpg"
  },
  {
   "section": "grid-limited",
   "limited": true,
   "title": "Joki Collector",
   "subtitle": "1 - 48 Jam",
   "via": "Joki",
   "img": "https://i.postimg.cc/sX6TQXRn/Picsart_26_01_05_01_55_24_896.jpg"
  },
  {
   "section": "grid-limited",
   "limited": true,
   "title": "Joki Annual Starlight",
   "subtitle": "1 - 48 Jam",
   "via": "Joki",
   "img": "https://i.postimg.cc/76sKG6ys/Picsart_26_01_03_23_46_35_113.jpg"
  },
  {
   "section": "grid-limited",
   "limited": true,
   "title": "M7 Pass",
   "subtitle": "7 - 10 Hari",
   "via": "Gift",
   "img": "https://i.postimg.cc/g0Hhk1j2/Picsart-26-01-01-17-58-58-120.jpg"
  },
  {
   "section": "grid-limited",
   "limited": true,
   "title": "Joki Recall Spongebob",
   "subtitle": "1 - 48 Jam",
   "via": "Log-In",
   "img": "https://i.postimg.cc/FRWTdRQb/Picsart_26_01_05_01_57_19_785.jpg"
  },
  {
   "section": "grid-limited",
   "limited": true,
   "title": "Joki Prime Instant",
   "subtitle": "1 - 48 Jam",
   "via": "Joki",
   "img": "https://i.postimg.cc/9QsG8sNm/Picsart-26-01-01-19-08-40-253.jpg"
  },
  {
   "section": "grid-limited",
   "limited": true,
   "title": "Via Redeem Code",
   "subtitle": "1 - 60 Minit",
   "via": "Nick ID Server",
   "img": "https://i.postimg.cc/Jn6pDnWx/Picsart_26_01_01_13_33_18_618.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Mobile Legends",
   "subtitle": "Malaysia",
   "via": "Nick ID Server",
   "img": "https://i.imghippo.com/files/mQK5675JF.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Mobile Legends",
   "subtitle": "Indonesia",
   "via": "Nick ID Server",
   "img": "https://i.imghippo.com/files/snG8316PY.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Mobile Legends",
   "subtitle": "0 - 48 Jam",
   "via": "Log-In",
   "img": "https://i.imghippo.com/files/ywk6509FJc.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Diamond MLBB Promo",
   "subtitle": "For Malaysia Only",
   "via": "Nick ID Server",
   "img": "https://i.postimg.cc/fTJYTCL8/Teks_perenggan_anda_20260104_061718_0000.jpg"
  },
  // {
  //   "section": "grid-ml",
  //   "limited": false,
  //   "title": "Event Ticket Recharge",
  //   "subtitle": "Malaysia/Indonesia",
  //   "via": "Nick ID Server",
  //   "img": "https://i.imghippo.com/files/kGE5778OlY.png"
  // },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Starlight Card",
   "subtitle": "7 - 10 Hari",
   "via": "Gift",
   "img": "https://i.postimg.cc/JnPx2sWh/Teks-perenggan-anda-20260101-162921-0000.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Joki Ranked",
   "subtitle": "Per Star",
   "via": "Joki",
   "img": "https://i.imghippo.com/files/HAL4478LM.jpg"
  },
  // {
  //   "section": "grid-ml",
  //   "limited": false,
  //   "title": "Joki Ranked",
  //   "subtitle": "Package",
  //   "via": "Joki",
  //   "img": "https://i.imghippo.com/files/xSU7487gI.png"
  // },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Joki Classic",
   "subtitle": "Package",
   "via": "Joki",
   "img": "https://i.imghippo.com/files/DKvP8649LdI.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Room Tournament",
   "subtitle": "Package",
   "via": "Nick ID Server",
   "img": "https://i.imghippo.com/files/RpP2840w.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Squad Verified",
   "subtitle": "Promo",
   "via": "Nick ID Server",
   "img": "https://i.imghippo.com/files/UCq1403WAc.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Joki Recall MPL",
   "subtitle": "1 - 48 Jam",
   "via": "Log-In",
   "img": "https://i.postimg.cc/3rLgTVKm/Teks_perenggan_anda_20260101_143942_0000.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Top Fan Avatar Border",
   "subtitle": "Package",
   "via": "Log-In",
   "img": "https://i.imghippo.com/files/ehoH2682Lyk.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Shop Item",
   "subtitle": "7 - 8 Hari",
   "via": "Gift",
   "img": "https://i.imghippo.com/files/Io6308PZY.jpg"
  },
  {
   "section": "grid-ml",
   "limited": false,
   "title": "Charisma",
   "subtitle": "1 - 60 Minit",
   "via": "Gift",
   "img": "https://i.imghippo.com/files/JD8419Oe.jpg"
  },
  {
   "section": "grid-topup",
   "limited": false,
   "title": "Genshin Impact",
   "subtitle": "1 - 10 Minit",
   "via": "UID Server",
   "img": "https://i.postimg.cc/xCMKY11b/abe019d59a86a88b52a6257ea454269e.jpg"
  },
  {
   "section": "grid-topup",
   "limited": false,
   "title": "Roblox",
   "subtitle": "1 - 48 Jam",
   "via": "Log-In",
   "img": "https://i.postimg.cc/Y9Y1kCCF/7bda34f18f5c5cb0909879c5699730a3.jpg"
  },
  {
   "section": "grid-topup",
   "limited": false,
   "title": "PUBG Mobile",
   "subtitle": "1 - 10 Minit",
   "via": "User ID",
   "img": "https://i.postimg.cc/tTWhy44P/88cec482ec921a5790bd9952d5a12ab3.jpg"
  },
  {
   "section": "grid-topup",
   "limited": false,
   "title": "Magic Chess",
   "subtitle": "1 - 10 Minit",
   "via": "Nick ID Server",
   "img": "https://i.postimg.cc/PxYmh55w/e09bf10ffcbc7ce3cadb3700f7ed1eaa_(1).jpg"
  },
  {
   "section": "grid-topup",
   "limited": false,
   "title": "Free Fire",
   "subtitle": "1 - 10 Minit",
   "via": "User ID",
   "img": "https://i.postimg.cc/SsCWqxxC/4e033b1a787b8a0ed1111f105b16fd15.jpg"
  },
  {
   "section": "grid-topup",
   "limited": false,
   "title": "Honor Of Kings",
   "subtitle": "1 - 10 Minit",
   "via": "User ID",
   "img": "https://i.postimg.cc/nzBvZhhv/134f33dc18ea6527fc4ee7c3cd86aa4e_(1).jpg"
  },
  {
   "section": "grid-medsos",
   "limited": false,
   "title": "Cinemas",
   "subtitle": "Telegram",
   "via": "Request",
   "img": "https://i.postimg.cc/bJkQ8wwx/6e9e2a46d687a9447c05d2e9262f9c4f.jpg"
  }
];

/* ===== UTIL ===== */
const slugify = (str) =>
  str.toString()
     .normalize('NFKD')
     .replace(/[\u0300-\u036f]/g,'')
     .replace(/[^a-z0-9]+/gi,'-')
     .replace(/^-+|-+$/g,'')
     .toLowerCase();

/* ===== CREATE CARD ===== */
function makeCard(item){
  const el = document.createElement("article");
  el.className = "card";
  el.tabIndex = 0;

  // theme ikut kategori (untuk corak warna)
  if(item.section === "grid-limited") el.dataset.theme = "limited";
  else if(item.section === "grid-ml") el.dataset.theme = "ml";
  else if(item.section === "grid-genshin") el.dataset.theme = "genshin";
  else if(item.section === "grid-topup") el.dataset.theme = "topup";
  else if(item.section === "grid-medsos") el.dataset.theme = "medsos";

  // ✅ IMAGE ONLY (tiada text bawah)
  el.innerHTML = `
    <div class="card-media">
      <img src="${item.img}" alt="${item.title}" loading="lazy">
    </div>
  `;

  // klik card → product page
  el.addEventListener("click", ()=>{
    const type = item.limited ? "limited" : "normal";
    const path = [item.title, item.subtitle, item.via]
      .map(encodeURIComponent).join("/");
    const qp = new URLSearchParams({
      img: item.img,
      type
    }).toString();

    location.href = `product.html#/${path}?${qp}`;
  });

  return el;
}

/* ===== REVEAL (instant, no animation berat) ===== */
function revealCards(scope = document){
  const cards = scope.querySelectorAll('.card:not(.show)');
  cards.forEach(el => {
    el.classList.add('show');
  });
}

/* ===== RENDER ===== */
function renderMainGrids(){
  const buckets = {
    "grid-limited": document.getElementById("grid-limited"),
    "grid-ml":      document.getElementById("grid-ml"),
    "grid-genshin": document.getElementById("grid-genshin"),
    "grid-topup":   document.getElementById("grid-topup"),
    "grid-medsos":  document.getElementById("grid-medsos"),
  };
  Object.values(buckets).forEach(w => w && (w.innerHTML = ""));
  DATA.forEach(item=>{
    const wrap = buckets[item.section];
    if (wrap) wrap.appendChild(makeCard(item));
  });
  revealCards();
}

/* ===== QUICK BAR FILTER ===== */
const CAT_TO_SECTION = {
  all:     ["section-limited","section-ml",/*"section-genshin",*/"section-topup","section-medsos"],
  limited: ["section-limited"],
  ml:      ["section-ml"],
  genshin: ["section-genshin"],
  topup:   ["section-topup"],
  medsos:  ["section-medsos"],
};

function setActiveQuick(cat){
  document.querySelectorAll(".qbtn").forEach(b=>{
    const on = b.dataset.cat === cat;
    b.classList.toggle("active", on);
    b.setAttribute("aria-pressed", on ? "true" : "false");
  });
}

function filterByCategory(cat){
  setActiveQuick(cat);
  clearSearch(false);

  const showSet = new Set(CAT_TO_SECTION[cat] || []);
  document.querySelectorAll("main .section").forEach(sec=>{
    const cls = [...sec.classList].find(c=>c.startsWith("section-"));
    if(!cls) return;
    sec.style.display = showSet.size===0 || showSet.has(cls) ? "" : "none";
  });
  revealCards(document);
}

/* ===== SEARCH (title only) ===== */
let debounceTimer = null;

function performSearch(q){
  const resWrap = document.getElementById("searchResults");
  const main = document.getElementById("mainContent");
  const query = q.trim().toLowerCase();

  if(query === ""){
    resWrap.classList.remove("active");
    resWrap.innerHTML = "";
    main.style.display = "";
    return;
  }

  const matched = DATA.filter(it => it.title.toLowerCase().includes(query));

  resWrap.innerHTML = "";
  const grid = document.createElement("div");
  grid.className = "grid";
  matched.forEach(item => grid.appendChild(makeCard(item)));
  if(matched.length === 0){
    const p = document.createElement("p");
    p.style.margin = "10px 4px";
    p.style.color = "#9fb6d0";
    p.textContent = "Tiada hasil ditemui.";
    resWrap.appendChild(p);
  } else {
    resWrap.appendChild(grid);
    revealCards(grid);
  }

  resWrap.classList.add("active");
  main.style.display = "none";
}

function clearSearch(keepInput=false){
  const input = document.getElementById("searchInput");
  const resWrap = document.getElementById("searchResults");
  const main = document.getElementById("mainContent");
  if(!keepInput) input.value = "";
  resWrap.classList.remove("active");
  resWrap.innerHTML = "";
  main.style.display = "";
}

/* ===== TESTIMONIAL SLIDER (anti-pop) ===== */
(function initTestimonialSlider(){
  const root = document.getElementById('tslider');
  if(!root) return;

  const viewport = root.querySelector('.ts-viewport');
  const track = root.querySelector('.ts-track');
  const prevBtn = root.querySelector('.ts-prev');
  const nextBtn = root.querySelector('.ts-next');
  const dotsWrap = root.querySelector('.ts-dots');

  let slides = Array.from(track.children);
  const perView = () => window.innerWidth >= 1024 ? 3 : (window.innerWidth >= 768 ? 2 : 1);

  const waitImages = async () => {
    const imgs = root.querySelectorAll('.ts-slide img');
    const jobs = [...imgs].map(img => (img.decode ? img.decode().catch(()=>{}) : Promise.resolve()));
    await Promise.all(jobs);
  };

  const makeClones = () => {
    const pv = perView();
    track.querySelectorAll('.ts-clone').forEach(n=>n.remove());
    const head = slides.slice(0, pv).map(n=>n.cloneNode(true));
    const tail = slides.slice(-pv).map(n=>n.cloneNode(true));
    head.forEach(n=>{
      n.classList.add('ts-clone');
      n.querySelector('img')?.setAttribute('loading','lazy');
      track.appendChild(n);
    });
    tail.forEach(n=>{
      n.classList.add('ts-clone');
      n.querySelector('img')?.setAttribute('loading','lazy');
      track.insertBefore(n, track.firstChild);
    });
  };

  const buildDots = () => {
    dotsWrap.innerHTML = '';
    slides.forEach((_,i)=>{
      const b = document.createElement('button');
      if(i===0) b.classList.add('active');
      b.addEventListener('click', ()=> goTo(i));
      dotsWrap.appendChild(b);
    });
  };

  let idx = 0, px = 0, slideW = 0, isAnimating = false;
  const setTranslate = (x) => { px = x; track.style.transform = `translate3d(${x}px,0,0)`; };

  const updateSizes = () => {
    slideW = viewport.clientWidth / perView();
    track.style.transition = 'none';
    setTranslate(-((idx + perView()) * slideW));
  };

  const activateDot = (i) => {
    dotsWrap.querySelectorAll('button').forEach((b,k)=> b.classList.toggle('active', k===i));
  };

  const goTo = (newIdx) => {
    if(isAnimating) return;
    isAnimating = true;
    idx = newIdx;
    activateDot(idx);
    if(root.classList.contains('is-ready'))
      track.style.transition = 'transform .35s ease';
    else
      track.style.transition = 'none';
    setTranslate(-((idx + perView()) * slideW));
  };

  const normalize = () => {
    const pv = perView();
    const total = slides.length;
    const current = Math.round(-px / slideW) - pv;
    if(current < 0){
      idx = total + current;
      track.style.transition = 'none';
      setTranslate(-((idx + pv) * slideW));
    } else if(current >= total){
      idx = current - total;
      track.style.transition = 'none';
      setTranslate(-((idx + pv) * slideW));
    } else {
      idx = current;
    }
    activateDot(idx);
    isAnimating = false;
  };

  const next = () => goTo((idx + 1) % slides.length);
  const prev = () => goTo((idx - 1 + slides.length) % slides.length);

  let autoTimer = null;
  const startAuto = () => { stopAuto(); autoTimer = setInterval(next, 3500); };
  const stopAuto = () => autoTimer && clearInterval(autoTimer);

  let dragging=false,startX=0,startPX=0;
  function onDown(e){
    dragging=true;
    root.classList.add('dragging');
    track.style.transition='none';
    startX=(e.touches?e.touches[0].clientX:e.clientX);
    startPX=px;
    stopAuto();
  }
  function onMove(e){
    if(!dragging)return;
    const x=(e.touches?e.touches[0].clientX:e.clientX);
    setTranslate(startPX + (x-startX));
  }
  function onUp(){
    if(!dragging)return;
    dragging=false;
    root.classList.remove('dragging');
    const moved=px-startPX;
    const threshold=slideW*0.2;
    track.style.transition='transform .3s ease';
    if(moved<-threshold) next();
    else if(moved>threshold) prev();
    else setTranslate(startPX);
    startAuto();
  }

  const init = async () => {
    slides = Array.from(track.querySelectorAll('.ts-slide')).filter(n=>!n.classList.contains('ts-clone'));
    makeClones();
    buildDots();
    idx = 0;
    updateSizes();
    await waitImages();
    normalize();
    root.classList.add('is-ready');
    requestAnimationFrame(()=> startAuto());
  };

  nextBtn.addEventListener('click', ()=>{ stopAuto(); next(); startAuto(); });
  prevBtn.addEventListener('click', ()=>{ stopAuto(); prev(); startAuto(); });

  viewport.addEventListener('pointerdown', onDown);
  window.addEventListener('pointermove', onMove);
  window.addEventListener('pointerup', onUp);
  viewport.addEventListener('touchstart', onDown, {passive:true});
  viewport.addEventListener('touchmove', onMove, {passive:true});
  window.addEventListener('touchend', onUp);

  root.addEventListener('mouseenter', stopAuto);
  root.addEventListener('mouseleave', startAuto);
  track.addEventListener('transitionend', normalize);

  window.addEventListener('resize', ()=>{
    makeClones();
    updateSizes();
    normalize();
  });

  init();
})();

/* ===== BOOTSTRAP ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  renderMainGrids();

  document.querySelectorAll(".qbtn").forEach(btn=>{
    btn.addEventListener("click", ()=> filterByCategory(btn.dataset.cat));
  });

  const input = document.getElementById("searchInput");
  const clear = document.getElementById("clearSearch");

  input.addEventListener("input", ()=>{
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=> performSearch(input.value), 200);
  });

  clear.addEventListener("click", ()=> clearSearch());

  filterByCategory("all");
});